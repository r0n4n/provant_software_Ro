/**
  ******************************************************************************
  * @file    subsystems/subsys_ContinousContorl/MpcControle.h
  * @author  Richard Andrade
  * @version V1.0.0
  * @date    27-Julho-2015
  * @brief   Mathematic Model for Load Transportation.
  *****************************************************************************/

/* Includes ------------------------------------------------------------------*/
#include "AircraftModel.h"
/* Private typedef -----------------------------------------------------------*/
/* Private define ------------------------------------------------------------*/
/* Private macro -------------------------------------------------------------*/
/* Private variables ---------------------------------------------------------*/


/* Exported functions definitions --------------------------------------------*/
namespace model {
/** \brief Função principal do módulo de RC.
  * @param  None
  * @retval None
  *
  * Interpreta o recebimento de PPM, calcula sinais de controle e os envia
  * via interface.
  * Devido as diferenças do modelo matematica com a construção mecanica o sinal do angulo do servo direito deve
  * ser adaptado.
  *
  */
AircraftModel::AircraftModel() {

}

AircraftModel::~AircraftModel() {
	// TODO Auto-generated destructor stub
}

void AircraftModel::LinearModel(Eigen::MatrixXf as, float ts, Eigen::MatrixXf * Az, Eigen::MatrixXf * Bz){
	/* Name spaces ------------------------------------------------------------------*/
	using namespace Eigen;
	float ddxr, ddyr, ddzr;
	/*Refrence aceleration*/
	ddxr=as(0,0);
	ddyr=as(1,0);
	ddzr=as(2,0);
	/*Linear Model*/
	MatrixXf A(16,16);
	MatrixXf B(16,4);
	MatrixXf C(2,16);
	/*Extended Model*/
	MatrixXf Aa(18,18);
	MatrixXf Ba(18,4);
	MatrixXf Ca(18,18);

	/*Matrix A*/
	A.setZero();
	A(0,8)=1.0;
	A(1,9)=1.0;
	A(2,10)=1.0;
	A(3,11)=1.0;
	A(4,12)=1.0;
	A(5,13)=1.0;
	A(6,14)=1.0;
	A(7,15)=1.0;
	A(8,3)=0.385155*ddyr - 0.000810738*ddxr - 0.00006139329999999999*ddzr - 0.000602268;
	A(8,4)=0.00324657*ddyr - 0.000000271808*ddxr + 1.00001*ddzr + 9.81006;
	A(8,5)=0.00164467*ddxr - 0.78133*ddyr;
	A(8,6)=1.06402*ddyr - 0.00223308*ddxr + 1.01096*ddzr + 9.917490000000001;
	A(8,7)=0.00225806*ddxr - 1.06957*ddyr + 1.01383*ddzr + 9.94571;
	A(8,14)=-0.0000364215;
	A(8,15)=-0.0000364109;
	A(9,3)=0.00267892*ddyr - 0.0000122004*ddxr - 0.999891*ddzr - 9.80893;
	A(9,4)=0.0517074*ddyr - 0.000108842*ddxr + 0.000012699*ddzr + 0.000124577;
	A(9,5)=0.02467*ddyr - 0.0000519295*ddxr;
	A(9,6)=0.0298909*ddyr - 0.00006273489999999999*ddxr + 0.0280948*ddzr + 0.27561;
	A(9,7)=0.0294709*ddyr - 0.0000622171*ddxr - 0.0277009*ddzr - 0.271746;
	A(9,14)=-0.0000000215367;
	A(9,15)=0.000000000663933;
	A(10,3)=0.781861*ddyr - 0.00164579*ddxr - 0.0000000603112*ddzr - 0.000000591653;
	A(10,4)=0.0000523419*ddxr - 0.0248659*ddyr - 0.0000000409284*ddzr - 0.000000401508;
	A(10,6)=0.000755298*ddyr - 0.00000158519*ddxr + 0.000714737*ddzr + 0.00701157;
	A(10,7)=0.00000197313*ddxr - 0.000934622*ddyr + 0.0008804350000000001*ddzr + 0.00863707;
	A(10,14)=-0.0000000610856;
	A(10,15)=-0.00000006115620000000001;
	A(11,3)=0.00196738*ddyr - 0.00000414023*ddxr + 0.000158919*ddzr + 0.001559;
	A(11,4)=0.00102769*ddxr - 0.488221*ddyr - 0.000187867*ddzr - 0.00184298;
	A(11,6)=0.0009942180000000001*ddxr - 0.473708*ddyr - 0.444967*ddzr - 4.36513;
	A(11,7)=0.000986128*ddxr - 0.467109*ddyr + 0.438786*ddzr + 4.30449;
	A(11,14)=0.000000329886;
	A(11,15)=0.00000000140342;
	A(12,3)=5.63166*ddyr - 0.0118545*ddxr - 0.000950154*ddzr - 0.009321009999999999;
	A(12,4)=0.0598436*ddyr - 0.000125968*ddxr + 0.0000568274*ddzr + 0.000557477;
	A(12,6)=8.600619999999999*ddyr - 0.0180506*ddxr + 8.133419999999999*ddzr + 79.7888;
	A(12,7)=0.0182617*ddxr - 8.65008*ddyr + 8.160740000000001*ddzr + 80.0568;
	A(12,14)=-0.0005812359999999999;
	A(12,15)=-0.000581128;
	A(13,3)=0.27475*ddyr - 0.00057829*ddxr + 0.00744252*ddzr + 0.0730112;
	A(13,4)=0.0192658*ddxr - 9.15255*ddyr - 0.008829760000000001*ddzr - 0.0866199;
	A(13,6)=4.71363*ddyr - 0.00989339*ddxr + 4.36487*ddzr + 42.8193;
	A(13,7)=4.74055*ddyr - 0.0100075*ddxr - 4.38071*ddzr - 42.9748;
	A(13,14)=0.00000826219;
	A(13,15)=-0.00000714437;
	A(14,3)=0.0125063*ddxr - 5.94134*ddyr + 0.00159447*ddzr + 0.0156417;
	A(14,4)=0.00180361*ddxr - 0.85684*ddyr - 0.000825301*ddzr - 0.0080962;
	A(14,6)=0.0171208*ddxr - 8.1576*ddyr - 7.72254*ddzr - 75.7581;
	A(14,7)=9.02993*ddyr - 0.0190635*ddxr - 8.51112*ddzr - 83.4941;
	A(14,14)=0.0467503;
	A(14,15)=0.000578299;
	A(15,3)=0.0124614*ddxr - 5.91999*ddyr + 0.00029729*ddzr + 0.00291642;
	A(15,4)=0.739233*ddyr - 0.00155606*ddxr + 0.000713644*ddzr + 0.00700085;
	A(15,6)=0.0188448*ddxr - 8.979010000000001*ddyr - 8.483169999999999*ddzr - 83.2199;
	A(15,7)=8.20356*ddyr - 0.0173191*ddxr - 7.74747*ddzr - 76.0027;
	A(15,14)=0.000578299;
	A(15,15)=0.0467501;
	/*Matrix B*/
	B.setZero();
	B(8,0)=1.170580E-05;
	B(8,1)=-1.172960E-05;
	B(8,2)=-7.284300E-03;
	B(8,3)=-7.282180E-03;
	B(9,0)=3.707360E-04;
	B(9,1)=-3.714920E-04;
	B(9,2)=-4.307330E-06;
	B(9,3)=1.327870E-07;
	B(10,0)=4.968150E-04;
	B(10,1)=4.993780E-04;
	B(10,2)=-1.221710E-05;
	B(10,3)=-1.223120E-05;
	B(11,0)=-5.223100E-03;
	B(11,1)=5.233750E-03;
	B(11,2)=6.597720E-05;
	B(11,3)=2.806850E-07;
	B(12,0)=1.882090E-04;
	B(12,1)=-1.885930E-04;
	B(12,2)=-1.162470E-01;
	B(12,3)=-1.162260E-01;
	B(13,0)=1.526460E-04;
	B(13,1)=-1.529580E-04;
	B(13,2)=1.652440E-03;
	B(13,3)=-1.428870E-03;
	B(14,0)=-1.742050E-04;
	B(14,1)=1.745600E-04;
	B(14,2)=9.350060E+00;
	B(14,3)=1.156600E-01;
	B(15,0)=-2.008070E-04;
	B(15,1)=2.012170E-04;
	B(15,2)=1.156600E-01;
	B(15,3)=9.350010E+00;
	/*Matrix C*/
	C.setZero();
	C(0,2)=1;
	C(1,5)=1;
	/*Extended Sistem*/
	Aa.setZero();
	Aa.block(0,0,16,16)=A;
	Aa.block(16,0,2,16)=C;

	Ba.setZero();
	Ba.block(0,0,16,4)=B;

	Ca=MatrixXf::Identity(18,18);
	/*Discretisation of de sistem(Euler Aproximation)*/
	*Az=MatrixXf::Identity(18,18)+Aa*ts;
	*Bz=Ba*ts;
}

Eigen::MatrixXf AircraftModel::MatrixSumRho(){
	using namespace Eigen;
	VectorXf Rho(18);
	Rho<<0,0,30,1.2159,1.2159,0.3040,1.2159,1.2159,0,0,0,0,0,0,0.001,0.001,1500,1500.1982;
	return Rho.asDiagonal();
}
Eigen::MatrixXf AircraftModel::MatrixSumLambda(){
	using namespace Eigen;
	Vector4f Lambda;
	Lambda<<1.9602E-08,1.9493E-08,1.1250E-05,1.1250E-05;
	return Lambda.asDiagonal();
}
Eigen::MatrixXf AircraftModel::RefrenceControl(Eigen::MatrixXf as){
	using namespace Eigen;
	float ddxr, ddyr, ddzr;
	ddxr=as(0,0);
	ddyr=as(1,0);
	ddzr=as(2,0);
	MatrixXf ur(4,1);
	float fR=9857.54 - 2.21085*ddxr + 1054.44*ddyr + 1004.85*ddzr;
	float fL=9837.48 + 2.22439*ddxr - 1054.62*ddyr + 1002.8*ddzr;
	float tauR=0;
	float tauL=0;
	ur<<fR,fL,tauR,tauL;
	return ur;

}
Eigen::MatrixXf AircraftModel::MatrixTerminalCost(){
	/* Name spaces ------------------------------------------------------------------*/
	using namespace Eigen;
	MatrixXf P(18,18);
	P.setZero();
	P(0,0)=7.661631E-05;
	P(0,1)=-2.585704E-09;
	P(0,2)=2.051197E-04;
	P(0,3)=5.153773E-05;
	P(0,4)=5.946248E-03;
	P(0,5)=1.389259E-04;
	P(0,6)=1.785693E-03;
	P(0,7)=1.758386E-03;
	P(0,8)=1.675422E-03;
	P(0,9)=1.260595E-06;
	P(0,10)=2.927712E-05;
	P(0,11)=9.575313E-06;
	P(0,12)=4.353812E-04;
	P(0,13)=1.054224E-05;
	P(0,14)=2.777010E-05;
	P(0,15)=2.734013E-05;
	P(0,16)=3.210695E-04;
	P(0,17)=3.253397E-04;
	P(1,0)=-2.585704E-09;
	P(1,1)=7.616362E-05;
	P(1,2)=1.680831E-04;
	P(1,3)=-5.188676E-03;
	P(1,4)=-5.602824E-05;
	P(1,5)=-7.814001E-04;
	P(1,6)=-1.022014E-04;
	P(1,7)=3.728181E-05;
	P(1,8)=1.231909E-06;
	P(1,9)=1.618818E-03;
	P(1,10)=2.605446E-05;
	P(1,11)=-4.024445E-04;
	P(1,12)=-1.054103E-05;
	P(1,13)=-9.247325E-05;
	P(1,14)=-1.446982E-06;
	P(1,15)=3.677170E-07;
	P(1,16)=3.413422E-04;
	P(1,17)=-2.663544E-03;
	P(2,0)=2.051197E-04;
	P(2,1)=1.680831E-04;
	P(2,2)=5.725238E+03;
	P(2,3)=-1.000481E+00;
	P(2,4)=1.258663E+00;
	P(2,5)=6.513054E-01;
	P(2,6)=1.066240E+00;
	P(2,7)=7.561852E-01;
	P(2,8)=1.224009E-02;
	P(2,9)=9.847142E-03;
	P(2,10)=5.940574E+02;
	P(2,11)=-1.818772E-01;
	P(2,12)=2.323311E-01;
	P(2,13)=8.721843E-02;
	P(2,14)=1.709146E-02;
	P(2,15)=1.297717E-02;
	P(2,16)=1.830276E+04;
	P(2,17)=1.877263E+00;
	P(3,0)=5.153773E-05;
	P(3,1)=-5.188676E-03;
	P(3,2)=-1.000481E+00;
	P(3,3)=3.076212E+01;
	P(3,4)=2.699414E-01;
	P(3,5)=4.361013E+00;
	P(3,6)=5.317271E-01;
	P(3,7)=-1.902778E-01;
	P(3,8)=2.832620E-03;
	P(3,9)=-3.042930E-01;
	P(3,10)=-1.552774E-01;
	P(3,11)=3.062747E+00;
	P(3,12)=5.245924E-02;
	P(3,13)=5.092709E-01;
	P(3,14)=7.532526E-03;
	P(3,15)=-1.892160E-03;
	P(3,16)=-2.021972E+00;
	P(3,17)=1.444247E+01;
	P(4,0)=5.946248E-03;
	P(4,1)=-5.602824E-05;
	P(4,2)=1.258663E+00;
	P(4,3)=2.699414E-01;
	P(4,4)=3.613996E+01;
	P(4,5)=7.768356E-01;
	P(4,6)=1.103651E+01;
	P(4,7)=1.090440E+01;
	P(4,8)=3.559746E-01;
	P(4,9)=-2.979223E-03;
	P(4,10)=2.463409E-01;
	P(4,11)=7.664664E-02;
	P(4,12)=3.976062E+00;
	P(4,13)=5.652077E-02;
	P(4,14)=1.800663E-01;
	P(4,15)=1.778882E-01;
	P(4,16)=1.951229E+00;
	P(4,17)=1.584205E+00;
	P(5,0)=1.389259E-04;
	P(5,1)=-7.814001E-04;
	P(5,2)=6.513054E-01;
	P(5,3)=4.361013E+00;
	P(5,4)=7.768356E-01;
	P(5,5)=3.822653E+02;
	P(5,6)=5.094928E+01;
	P(5,7)=-4.951832E+01;
	P(5,8)=8.273986E-03;
	P(5,9)=-4.574920E-02;
	P(5,10)=1.379816E-01;
	P(5,11)=9.361832E-01;
	P(5,12)=5.929153E-02;
	P(5,13)=3.678659E+01;
	P(5,14)=6.113551E-01;
	P(5,15)=-5.923646E-01;
	P(5,16)=7.889054E-01;
	P(5,17)=1.757715E+03;
	P(6,0)=1.785693E-03;
	P(6,1)=-1.022014E-04;
	P(6,2)=1.066240E+00;
	P(6,3)=5.317271E-01;
	P(6,4)=1.103651E+01;
	P(6,5)=5.094928E+01;
	P(6,6)=1.838633E+01;
	P(6,7)=-2.518205E+00;
	P(6,8)=1.071533E-01;
	P(6,9)=-5.898205E-03;
	P(6,10)=1.977847E-01;
	P(6,11)=1.556145E-01;
	P(6,12)=1.789268E+00;
	P(6,13)=5.609314E+00;
	P(6,14)=2.626446E-01;
	P(6,15)=-7.534295E-03;
	P(6,16)=2.023780E+00;
	P(6,17)=2.127310E+02;
	P(7,0)=1.758386E-03;
	P(7,1)=3.728181E-05;
	P(7,2)=7.561852E-01;
	P(7,3)=-1.902778E-01;
	P(7,4)=1.090440E+01;
	P(7,5)=-4.951832E+01;
	P(7,6)=-2.518205E+00;
	P(7,7)=1.811932E+01;
	P(7,8)=1.055233E-01;
	P(7,9)=2.268679E-03;
	P(7,10)=1.375670E-01;
	P(7,11)=-6.495959E-02;
	P(7,12)=1.777131E+00;
	P(7,13)=-5.513949E+00;
	P(7,14)=-7.316112E-03;
	P(7,15)=2.581057E-01;
	P(7,16)=1.508960E+00;
	P(7,17)=-2.083919E+02;
	P(8,0)=1.675422E-03;
	P(8,1)=1.231909E-06;
	P(8,2)=1.224009E-02;
	P(8,3)=2.832620E-03;
	P(8,4)=3.559746E-01;
	P(8,5)=8.273986E-03;
	P(8,6)=1.071533E-01;
	P(8,7)=1.055233E-01;
	P(8,8)=9.951125E-02;
	P(8,9)=1.473066E-04;
	P(8,10)=1.755084E-03;
	P(8,11)=5.564619E-04;
	P(8,12)=2.624148E-02;
	P(8,13)=6.261649E-04;
	P(8,14)=1.667558E-03;
	P(8,15)=1.641798E-03;
	P(8,16)=1.908992E-02;
	P(8,17)=1.903017E-02;
	P(9,0)=1.260595E-06;
	P(9,1)=1.618818E-03;
	P(9,2)=9.847142E-03;
	P(9,3)=-3.042930E-01;
	P(9,4)=-2.979223E-03;
	P(9,5)=-4.574920E-02;
	P(9,6)=-5.898205E-03;
	P(9,7)=2.268679E-03;
	P(9,8)=1.473066E-04;
	P(9,9)=9.443152E-02;
	P(9,10)=1.530425E-03;
	P(9,11)=-2.369203E-02;
	P(9,12)=-5.947326E-04;
	P(9,13)=-5.421850E-03;
	P(9,14)=-8.340949E-05;
	P(9,15)=2.289996E-05;
	P(9,16)=1.991759E-02;
	P(9,17)=-1.556549E-01;
	P(10,0)=2.927712E-05;
	P(10,1)=2.605446E-05;
	P(10,2)=5.940574E+02;
	P(10,3)=-1.552774E-01;
	P(10,4)=2.463409E-01;
	P(10,5)=1.379816E-01;
	P(10,6)=1.977847E-01;
	P(10,7)=1.375670E-01;
	P(10,8)=1.755084E-03;
	P(10,9)=1.530425E-03;
	P(10,10)=8.161446E+01;
	P(10,11)=-3.394990E-02;
	P(10,12)=4.501748E-02;
	P(10,13)=1.709912E-02;
	P(10,14)=3.191568E-03;
	P(10,15)=2.399618E-03;
	P(10,16)=1.601712E+03;
	P(10,17)=4.883627E-01;
	P(11,0)=9.575313E-06;
	P(11,1)=-4.024445E-04;
	P(11,2)=-1.818772E-01;
	P(11,3)=3.062747E+00;
	P(11,4)=7.664664E-02;
	P(11,5)=9.361832E-01;
	P(11,6)=1.556145E-01;
	P(11,7)=-6.495959E-02;
	P(11,8)=5.564619E-04;
	P(11,9)=-2.369203E-02;
	P(11,10)=-3.394990E-02;
	P(11,11)=5.253311E-01;
	P(11,12)=1.439973E-02;
	P(11,13)=1.247246E-01;
	P(11,14)=2.152987E-03;
	P(11,15)=-6.385701E-04;
	P(11,16)=-3.573413E-01;
	P(11,17)=3.333707E+00;
	P(12,0)=4.353812E-04;
	P(12,1)=-1.054103E-05;
	P(12,2)=2.323311E-01;
	P(12,3)=5.245924E-02;
	P(12,4)=3.976062E+00;
	P(12,5)=5.929153E-02;
	P(12,6)=1.789268E+00;
	P(12,7)=1.777131E+00;
	P(12,8)=2.624148E-02;
	P(12,9)=-5.947326E-04;
	P(12,10)=4.501748E-02;
	P(12,11)=1.439973E-02;
	P(12,12)=6.019863E-01;
	P(12,13)=4.707063E-03;
	P(12,14)=2.982636E-02;
	P(12,15)=2.953450E-02;
	P(12,16)=4.116989E-01;
	P(12,17)=-2.078350E-01;
	P(13,0)=1.054224E-05;
	P(13,1)=-9.247325E-05;
	P(13,2)=8.721843E-02;
	P(13,3)=5.092709E-01;
	P(13,4)=5.652077E-02;
	P(13,5)=3.678659E+01;
	P(13,6)=5.609314E+00;
	P(13,7)=-5.513949E+00;
	P(13,8)=6.261649E-04;
	P(13,9)=-5.421850E-03;
	P(13,10)=1.709912E-02;
	P(13,11)=1.247246E-01;
	P(13,12)=4.707063E-03;
	P(13,13)=3.915214E+00;
	P(13,14)=6.878342E-02;
	P(13,15)=-6.748930E-02;
	P(13,16)=1.369737E-01;
	P(13,17)=1.580410E+02;
	P(14,0)=2.777010E-05;
	P(14,1)=-1.446982E-06;
	P(14,2)=1.709146E-02;
	P(14,3)=7.532526E-03;
	P(14,4)=1.800663E-01;
	P(14,5)=6.113551E-01;
	P(14,6)=2.626446E-01;
	P(14,7)=-7.316112E-03;
	P(14,8)=1.667558E-03;
	P(14,9)=-8.340949E-05;
	P(14,10)=3.191568E-03;
	P(14,11)=2.152987E-03;
	P(14,12)=2.982636E-02;
	P(14,13)=6.878342E-02;
	P(14,14)=4.907553E-03;
	P(14,15)=3.235640E-04;
	P(14,16)=3.242532E-02;
	P(14,17)=2.513590E+00;
	P(15,0)=2.734013E-05;
	P(15,1)=3.677170E-07;
	P(15,2)=1.297717E-02;
	P(15,3)=-1.892160E-03;
	P(15,4)=1.778882E-01;
	P(15,5)=-5.923646E-01;
	P(15,6)=-7.534295E-03;
	P(15,7)=2.581057E-01;
	P(15,8)=1.641798E-03;
	P(15,9)=2.289996E-05;
	P(15,10)=2.399618E-03;
	P(15,11)=-6.385701E-04;
	P(15,12)=2.953450E-02;
	P(15,13)=-6.748930E-02;
	P(15,14)=3.235640E-04;
	P(15,15)=4.792196E-03;
	P(15,16)=2.536239E-02;
	P(15,17)=-2.772525E+00;
	P(16,0)=3.210695E-04;
	P(16,1)=3.413422E-04;
	P(16,2)=1.830276E+04;
	P(16,3)=-2.021972E+00;
	P(16,4)=1.951229E+00;
	P(16,5)=7.889054E-01;
	P(16,6)=2.023780E+00;
	P(16,7)=1.508960E+00;
	P(16,8)=1.908992E-02;
	P(16,9)=1.991759E-02;
	P(16,10)=1.601712E+03;
	P(16,11)=-3.573413E-01;
	P(16,12)=4.116989E-01;
	P(16,13)=1.369737E-01;
	P(16,14)=3.242532E-02;
	P(16,15)=2.536239E-02;
	P(16,16)=8.634228E+04;
	P(16,17)=5.365669E-01;
	P(17,0)=3.253397E-04;
	P(17,1)=-2.663544E-03;
	P(17,2)=1.877263E+00;
	P(17,3)=1.444247E+01;
	P(17,4)=1.584205E+00;
	P(17,5)=1.757715E+03;
	P(17,6)=2.127310E+02;
	P(17,7)=-2.083919E+02;
	P(17,8)=1.903017E-02;
	P(17,9)=-1.556549E-01;
	P(17,10)=4.883627E-01;
	P(17,11)=3.333707E+00;
	P(17,12)=-2.078350E-01;
	P(17,13)=1.580410E+02;
	P(17,14)=2.513590E+00;
	P(17,15)=-2.772525E+00;
	P(17,16)=5.365669E-01;
	P(17,17)=9.479796E+03;
	return P;
}
Eigen::VectorXf AircraftModel::OutputMaxVector(){
	using namespace Eigen;
	VectorXf ymax(18,1);
	ymax<< 4,4,24,2,2.4,2,2.4,2.4,40,40,40,40,40,40,240,240,2,2;
	return ymax;
}
Eigen::VectorXf AircraftModel::OutputMinVector(){
	using namespace Eigen;
	VectorXf ymin(18,1);
	ymin<< -4,-4,-24,-2,-2.4,-2,-2.4,-2.4,-40,-40,-40,-40,-40,-40,-240,-240,-2,-2;
	return ymin;
}
Eigen::VectorXf AircraftModel::ControlMaxVector(){
	using namespace Eigen;
	VectorXf umax(4,1);
	umax<< 17000,17000,2000,2000;
	return umax;
}
Eigen::VectorXf AircraftModel::ControlMinVector(){
	using namespace Eigen;
	VectorXf umin(4,1);
	umin<< 0,0,-2000,-2000;
	return umin;
}
/* Private functions ---------------------------------------------------------*/
} /* namespace loadmodel */
